%testing the controler against a simulated plant-actuator model


pidstate=[];
pidstate.initalize=1;
pidstate.ctr_output=0;
pidstate.setpt=1;
pidstate.verbose=3;
pidstate.k_int=-0.1;
pidstate.k_prop=1e-8;
pidstate.outlims=[-1 1];
pidstate.aw_thresh_range=0.01; %how far away from the edge AW starts 
pidstate.int_lim=3;        %limits on the integerator term
pidstate.slew_lim=1e-5;    %

sim.run.time=0;
sim.run.itt=0;
sim.set.tmax=1;
sim.set.dt=1e-5;
sim.set.pid_poll_time=1e-2;
sim.set.pid_calltime=1e-3;
pidstate.time=sim.run.time; %only for simulation for realtime(ish) do not set

sim.run.plant_temp=2;
sim.set.plant_heater_strength=1e-2;
sim.run.plant_load=1;
sim.set.plant_drift=1e-9;

iimax=ceil(sim.set.tmax/sim.set.dt);
sim.history.plant_temp=[];
sim.history.plant_load=[];
sim.history.time=[];


while sim.run.itt<iimax
sim.run.time=sim.run.time+sim.set.dt;
sim.run.itt=sim.run.itt+1;
if sim.run.time>pidstate.time+sim.set.pid_poll_time
    pidstate.set_time=sim.run.time;
    pidstate=pid_loop(pidstate);
    pidstate.time=sim.run.time;
end
sim.run.plant_temp=sim.run.plant_temp+sim.set.plant_heater_strength*pidstate.ctr_output-sim.run.plant_load;
sim.run.plant_load=sim.run.plant_load+sim.set.plant_drift*rand(1);


sim.history.plant_temp=[sim.history.plant_temp,sim.run.plant_temp];
sim.history.plant_load=[sim.history.plant_load,sim.run.plant_load];
sim.history.time=[sim.history.time,sim.run.time];

end


%%

plot(sim.history.time,sim.history.plant_temp)